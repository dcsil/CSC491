name: changelog

on:
  push:
    branches:
      - master
  release:
    types:
      - published

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1.18.0
        with:
          # Engine and version to use, see the syntax in the README. Reads from .ruby-version if unset.
          ruby-version: 2.6.5
      - name: Install github_changelog_generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gem install github_changelog_generator
          github_changelog_generator -u dcsil -p csc491 -t $GITHUB_TOKEN
      - name: Commit files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add --all .
          git commit -m "Update CHANGELOG"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Add report file
          title: 'Update CHANGELOG'
          body: |
            Automated update of changelog on release
          labels: automerge
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          event-type: changelog
          
